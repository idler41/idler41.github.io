## ruoyi 认证与鉴权

登录流程：

1. 用户名密码接口请求(/login)
2. 删除老token(redis)
3. 验证码校验
4. 用户名密码校验
5. 生成token + 缓存token与权限(redis)

验证流程：

1. filter拦截请求(JwtAuthenticationTokenFilter)
2. 解码jwt，根据解码的jwt信息加载用户与权限信息(redis)
3. token过期时间符合续期范围则token续期

问题：

1. jwt使请求header长度过长，公网环境增大服务器带宽压力，解密过程耗费cpu算力
2. 为了实现jwt续期功能，用redis来缓存，失去服务端不保存session状态优势
3. 每个用户都缓存权限信息，用户量大后，增大redis缓存压力
4. 更新权限信息后，用户需要重新登录才能生效


## blocks 认证与鉴权

1. 用户名密码接口请求(/login)
2. 用户名密码校验
3. 删除老token + 生成新token + 缓存token(redis)

验证流程：

1. filter拦截请求
2. 验证token + 缓存subjectId
3. token过期时间符合续期范围则token续期
4. 查询用户所属角色的权限信息，进行角色鉴权


rbac => (数据权限：组织树 + 角色-组织关联) + (资源权限：目录树 + 角色-目录关联)

问题：

1. 角色-权限、角色-组织的关联关系用缓存保存，当组织/权限数据更新后，所有角色-组织/权限的缓存都要清空，存在缓存与db数据不一致性问题



数据不一致性问题解决(最终一致性)：

缓存采用二级缓存，本地缓存过期时间1s，redis订阅监听jetCache缓存事件

1. 先更新数据库、后删除缓存
2. 手动清除缓存兜底

更新目录、组织在并发低场景下执行，最好更新几秒后手动清除缓存一次(延迟双删),减少不一致概率。
